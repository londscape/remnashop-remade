name: Remnashop - Dev CI/CD

on:
  push:
    branches:
      - dev

jobs:
  docker-build:
    name: ğŸ—ï¸ Build and Push Docker Image
    runs-on: ubuntu-latest
    outputs:
      image-tag: ghcr.io/${{ github.repository }}:dev
    steps:
      - name: ğŸ§¾ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Set Up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: ğŸ·ï¸ Build and Push Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ghcr.io/${{ github.repository }}:dev

  release:
    name: ğŸ“¦ Build and Publish Dev Artifact
    runs-on: ubuntu-latest
    needs: docker-build
    steps:
      - name: ğŸ§¾ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§± Generate Build Metadata
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          BRANCH="${{ github.ref_name }}"
          FULL_SHA="${{ github.sha }}"
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/$SHORT_SHA"

          cat <<-EOF > build.info.json
          {
            "buildTime": "$BUILD_TIME",
            "commitFull": "$FULL_SHA",
            "commit": "$SHORT_SHA",
            "tag": "dev-build",
            "branch": "$BRANCH",
            "commitUrl": "$COMMIT_URL"
          }
          EOF

      - name: ğŸ“ Archive Project Files
        run: zip -r remnashop-dev.zip . -x ".git/*" ".github/*" "logs/*" "*.zip"

      - name: ğŸ§¹ Remove Previous Artifact
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release delete-asset dev-build remnashop-dev.zip || true

      - name: â¬†ï¸ Upload Artifact to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload dev-build remnashop-dev.zip --clobber

      - name: ğŸ“ Update Release Notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')

          gh release edit dev-build --notes-file - <<EOF
          ğŸ” Updated development build
          ğŸ”— [Commit]($COMMIT_URL)  
          ğŸ“… Built: $DATE
          EOF
